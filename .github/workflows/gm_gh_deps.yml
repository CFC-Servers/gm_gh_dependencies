name: "Gmod Github Dependencies"

on:
  workflow_call:
    config-file:
      type: string
      description: "Path to the dependency config YAML"
      default: "gm_dependencies.yml"
      required: false

    input-branch:
      type: string
      description: "Which branch to merge dependencies into"
      default: ${{ github.event.repository.default_branch }}
      required: false

    output-branch:
      type: string
      description: "Which branch to force-push the merged dependency code to"
      default: "with-deps"
      required: false

jobs:
  obfuscate:
    name: "Resolve Dependencies"
    runs-on: ubuntu-18.04

    steps:
      - name: "Check out the repo"
        uses: actions/checkout@v2
        with:
          repository: ${{ github.repository }}
          path: project
          ref: ${{ inputs.input-branch }}
          fetch-depth: 0

      - name: "Install YQ"
        run: |
          sudo apt-key adv --keyserver keyserver.ubuntu.com --recv-keys CC86BB64
          sudo add-apt-repository ppa:rmescandon/yq;
          sudo apt update;
          sudo apt install yq -y;

      - name: "Merge dependencies"
        run: |
          cd "$GITHUB_WORKSPACE/";
          git clone --single-branch --no-tags
          sleep 1;

      - name: "Git status"
        run: |
          cd "$GITHUB_WORKSPACE/project"
          git status

      - name: "Remove .github"
        run: |
          cd "$GITHUB_WORKSPACE/project"
          rm -rfv .github

      - name: "Create VERSION file"
        run: |
          cd "$GITHUB_WORKSPACE/project"
          echo -e "${{ github.sha }}" > VERSION

      - name: Stage commit
        run: |
          cd "$GITHUB_WORKSPACE/project"
          git config user.name github-actions
          git config user.email github-actions@github.com
          git add .
          git commit -m "Dependency update"

      - name: Push to branch
        run: |
          cd "$GITHUB_WORKSPACE/project"
          git push -f origin "HEAD:${{ inputs.output-branch }}"
